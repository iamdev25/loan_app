name: Android Build

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Setup Node.js 22
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    # 3Ô∏è‚É£ Install npm dependencies
    - name: Install npm packages
      run: npm install

    # 4Ô∏è‚É£ Build Vue project
    - name: Build Vue project
      run: npm run build

    # 5Ô∏è‚É£ Add Android platform if not exists
    - name: Add Android platform
      run: npx cap add android || echo "Android platform already added"

    # 6Ô∏è‚É£ Sync Capacitor
    - name: Sync Capacitor
      run: npx cap sync android

    # 7Ô∏è‚É£ Setup JDK 21
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: 21

    # 8Ô∏è‚É£ Decode keystore from secret
    - name: Decode keystore
      run: |
        mkdir -p android/app
        echo "$KEYSTORE_BASE64" | base64 --decode > $GITHUB_WORKSPACE/android/app/my-release-key.jks

    # 9Ô∏è‚É£ Build signed APK
    - name: Build signed APK
      run: |
       cd android
       ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/android/app/my-release-key.jks \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD

    # üîü Upload signed APK artifact
    - uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: android/app/build/outputs/apk/release/*.apk
